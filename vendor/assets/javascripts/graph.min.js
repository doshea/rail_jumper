function Graph(b,c,a){this.canvas=null;this.context=null;this.lines=[];this.width=0;this.height=0;this.drawn=false;this.alerted=false;this.options={minValue:"auto",maxValue:"auto",padding:20,spacing:10,border:0.5,borderColor:"#ddd",background:["#fff","#f8f8f8"],grid:true,gridX:true,gridY:true,gridYCount:2,gridSize:0.5,gridColor:"rgb(150, 150, 150 )",gridShadow:false,gridDotted:true,axis:"auto",axisSize:"auto",axisColor:"auto",axisShadow:"auto",bullets:true,bulletSize:5,bulletColor:"#000",bulletFill:false,bulletShadow:false,shadowColor:"rgba(0, 0, 0, 0.6)",fill:true,fillColor:["rgba(138,184,125,0.2)","rgba(138,184,125,0.6)"],lineSize:3,lineCurve:true,lineColor:"#8AB87D",useOffset:true,valueKey:"value"};
if(!this.init(b)){alert("[graph] invalid canvas element, aborting.");return false;}if(c){this.addLine(c,"default","default");}if(a){this.draw();}}Graph.prototype.init=function(a){if(!a||!a.getContext){return false;}this.canvas=a||false;this.context=this.canvas.getContext("2d");this.width=Math.max(this.canvas.width,this.canvas.clientWidth);
this.height=Math.max(this.canvas.height,this.canvas.clientHeight);return true;};Graph.prototype.addLine=function(e,g,h){var d=[];var b=[];for(var a=0;a<e.length;a++){if(typeof(e[a])=="number"||typeof(e[a])=="string"){d.push(e[a]);}else{var f={};for(var c in e[a]){if(e[a][c].hasOwnProperty()){continue;
}f[c]=e[a][c];}if(typeof(e[a][this.options.valueKey])=="undefined"){alert("[Graph] invalid meta-data, no '"+this.options.valueKey+"' field found.");return;}d.push(e[a][this.options.valueKey]);b.push(f);}}this.lines.push({data:d,lineColor:g||"default",fillColor:h||"default",bullets:[],meta:b});if(this.drawn){this.redraw();
}};Graph.prototype.getLines=function(){return this.lines;};Graph.prototype.clearLines=function(){this.lines=null;delete this.lines;this.lines=[];};Graph.prototype.draw=function(){if(this.lines.length<=0||this.lines[0]["data"].length<3){if(!this.alerted){alert("[Graph] there is not really enough data for a nice looking graph.");
this.alerted=true;}return false;}this.alerted=false;if(this.options.background!==false){this.drawBackground();}if(this.options.grid){this.drawGrid();}if(this.options.axis===true||(this.options.axis=="auto"&&this.options.grid==true)){this.drawAxis();}for(var b=0;b<this.lines.length;b++){this.lines[b]["bullets"]=this.calculateBulletPoints(this.lines[b]["data"]);
var a=this.calculateControlPoint(this.lines[b]["bullets"]);this.lines[b]["start"]=a.start;this.lines[b]["end"]=a.end;if(this.options.fill){this.fillLineData(this.lines[b],this.lines[b]["fillColor"]=="default"?this.options.fillColor:this.lines[b]["fillColor"]);}var c=(!this.options.fill?this.lines[b]["lineColor"]:"default");
var c=this.lines[b]["lineColor"]=="default"?this.options.lineColor:this.lines[b]["lineColor"];this.drawLineData(this.lines[b],c);if(this.options.bullets){this.drawBulletPoints(this.lines[b],c);}}this.drawn=true;};Graph.prototype.drawBackground=function(){if(this.options.border>0){this.context.fillStyle=this.parseColor(this.options.borderColor);
this.context.fillRect(0,0,this.width,this.height);this.context.fillStyle=this.parseColor(this.options.background);this.context.fillRect(this.options.border,this.options.border,this.width-(this.options.border*2),this.height-(this.options.border*2));}else{this.context.fillStyle=this.parseColor(this.options.background);
this.context.fillRect(0,0,this.width,this.height);}};Graph.prototype.drawGrid=function(){if(this.options.gridY){this.drawGridY();}if(this.options.gridX){this.drawGridX();}};Graph.prototype.drawAxis=function(){var g=this.options.padding+(this.options.border>0?this.options.border:0);var c=g;var b=this.height-g;
var a=this.height-(g*2);var e=this.width-(g*2);var f=this.lines[0]["data"].length;var h=e;this.context.strokeStyle=this.options.axisColor=="auto"?this.options.gridColor:this.options.axisColor;this.context.lineWidth=this.options.axisSize=="auto"?this.options.gridSize:this.options.axisSize;var d=this.options.axisShadow=="auto"?this.options.gridShadow:this.options.axisShadow;
if(d){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}this.context.beginPath();this.context.moveTo(c,g);this.context.lineTo(c,b);this.context.stroke();this.context.beginPath();this.context.moveTo(c,b);
this.context.lineTo((this.width-c),b);this.context.stroke();};Graph.prototype.drawGridY=function(){var l=this.options.padding+(this.options.border>0?this.options.border:0);var i=l;var g=this.height-l;var m=this.height-(l*2);var c=this.width-(l*2);var d=this.options.gridYCount;var b=m;b=b/(d+1);this.context.strokeStyle=this.options.gridColor;
this.context.lineWidth=this.options.gridSize;if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}var a=2;var k=(c-i)+l;var e=k/a;for(var f=0;f<d;f++){var h=i+((f+1)*b);
if(this.options.gridDotted){var j=l;while(j+a<=k+l){this.context.beginPath();this.context.moveTo(j,h);this.context.lineTo(j+a,h);this.context.stroke();j+=(a*2);}}else{this.context.beginPath();this.context.moveTo(i,h);this.context.lineTo(c+l,h);this.context.stroke();}}};Graph.prototype.drawGridX=function(){var o=this.options.padding+(this.options.border>0?this.options.border:0);
var l=o;var j=this.height-o;var p=this.height-(o*2);var c=this.width-(o*2);var d=this.lines[0]["data"].length;var b=c;if(this.lines.length>1){for(var h=0;h<this.lines.length;h++){if(this.lines[h]["data"].length>d){d=this.lines[h]["data"].length;}}}b=b/(d-1);this.context.strokeStyle=this.options.gridColor;
this.context.lineWidth=this.options.gridSize;if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}var a=2;var e=(j-o);var f=e/a;for(var g=1;g<d-1;g++){var k=l+(g*b);
if(this.options.gridDotted){var n=o;this.context.strokeStyle=this.options.gridColor;this.context.lineWidth=this.options.gridSize;if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;
}while(n+a<=e+o){this.context.beginPath();this.context.moveTo(k,n);this.context.lineTo(k,n+a);this.context.stroke();n+=(a*2);}}else{this.context.strokeStyle=this.options.gridColor;this.context.lineWidth=this.options.gridSize;var m=this.options.gridShadow;if(m){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;
this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}this.context.beginPath();this.context.moveTo(k,o);this.context.lineTo(k,j);this.context.stroke();}}};Graph.prototype.drawBulletPoints=function(g,f){var d=g.bullets;var j=this.options.padding+(this.options.border>0?this.options.border:0);
var i=j;var h=this.height-j;var k=this.height-(j*2);var b=this.width-(j*2);var c=d.length;var f=f||"default";this.context.lineWidth=this.options.bulletSize/3;this.context.lineWidth=this.context.lineWidth<1?1:this.context.lineWidth;this.context.strokeStyle=this.parseColor(f=="default"?this.options.lineColor:f);
this.context.fillStyle=this.options.bulletFill?this.parseColor(this.options.bulletColor):this.context.strokeStyle;if(this.options.bulletShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=this.options.lineSize-1;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;
}for(var e=0;e<d.length;e++){var a=d[e];this.context.beginPath();this.context.arc(a.x,a.y,this.options.bulletSize,0,Math.PI*2,false);this.context.closePath();this.context.fill();if(this.options.bulletFill){this.context.stroke();}}};Graph.prototype.drawLineData=function(h,f){var d=h.bullets;var m=this.options.padding+(this.options.border>0?this.options.border:0);
var l=this.options.spacing;var j=m;var i=this.height-m-l;var n=this.height-(m*2)-(l*2);var b=this.width-(m*2);var c=d.length;var f=f||"default";this.context.beginPath();this.context.moveTo(d[0].x,d[0].y);if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=this.options.lineSize-1;
this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}this.context.strokeStyle=this.parseColor(f=="default"?this.options.lineColor:f);this.context.lineWidth=this.options.lineSize;this.context.lineCap="round";this.context.lineJoin="bevel";for(var e=0;e<d.length;e++){var a=d[e];
var g=typeof(d[e-1])!="undefined"?d[e-1]:a;var k=typeof(d[e+1])!="undefined"?d[e+1]:a;if(this.options.lineCurve&&c<3){this.options.lineCurve=false;}if(!this.options.lineCurve){this.context.lineTo(a.x,a.y);}else{if(e==(d.length-1)){break;}if(e==0){this.context.moveTo(a.x,a.y);}this.context.bezierCurveTo(h.start[e].x,h.start[e].y,h.end[e].x,h.end[e].y,k.x,k.y);
}}this.context.stroke();};Graph.prototype.fillLineData=function(h,f){var d=h.bullets;var l=this.options.padding+(this.options.border>0?this.options.border:0);var j=l;var i=this.height-l;var m=this.height-(l*2);var b=this.width-(l*2);var c=d.length;this.context.beginPath();this.context.moveTo(j,i);this.context.shadowBlur=0;
for(var e=0;e<d.length;e++){var a=d[e];var g=typeof(d[e-1])!="undefined"?d[e-1]:a;var k=typeof(d[e+1])!="undefined"?d[e+1]:a;if(this.options.lineCurve&&c<3){this.options.lineCurve=false;}if(!this.options.lineCurve){this.context.lineTo(a.x,a.y);}else{if(e==(d.length-1)){break;}if(e==0){this.context.moveTo(a.x,a.y);
}this.context.bezierCurveTo(h.start[e].x,h.start[e].y,h.end[e].x,h.end[e].y,k.x,k.y);}}this.context.lineTo(j+b,i);this.context.lineTo(j,i);this.context.fillStyle=this.parseColor(f);this.context.fill();};Graph.prototype.getMinimum=function(){var b=[];for(var a=0;a<this.lines.length;a++){b.push(Math.min.apply(Math,this.lines[a]["data"]));
}return Math.min.apply(Math,b);};Graph.prototype.getMaximum=function(){var b=[];for(var a=0;a<this.lines.length;a++){b.push(Math.max.apply(Math,this.lines[a]["data"]));}return Math.max.apply(Math,b);};Graph.prototype.calculateBulletPoints=function(s){var i=this.options.padding+(this.options.border>0?this.options.border:0);
var e=this.options.spacing;var p=i;var o=this.height-i-e;var l=this.height-(i*2)-(e*2);var m=this.width-(i*2);var b=s.length;var k=this.options.minValue=="auto"?this.getMinimum():this.options.minValue;var q=this.options.maxValue=="auto"?this.getMaximum():this.options.maxValue;var a=[];var c=m/(b-1);var d=p;
var r=Math.abs(q-k);var g=l/100;for(var f=0;f<b;f++){var n=s[f]-k;var h=Math.round((n/r)*100);var j=o-(g*h);a.push({x:d,y:j,value:s[f],number:f});d+=c;}return a;};Graph.prototype.calculateControlPoint=function(f){var c=f.length-1;var e=[];var b=[];var d=[];var g=[];for(var a=1;a<(c-1);a++){e[a]=4*f[a].x+2*f[a+1].x;
b[a]=4*f[a].y+2*f[a+1].y;}e[0]=f[0].x+2*f[1].x;b[0]=f[0].y+2*f[1].y;e[c-1]=(8*f[c-1].x+f[c].x)/2;b[c-1]=(8*f[c-1].y+f[c].y)/2;var e=this.processControlPoint(e);var b=this.processControlPoint(b);for(var a=0;a<c;a++){d[a]={x:e[a],y:b[a]};}for(var a=0;a<c;a++){if(a<(c-1)){g[a]={x:2*f[a+1].x-d[a+1].x,y:2*f[a+1].y-d[a+1].y};
}else{g[a]={x:(f[c].x+d[a].x)/2,y:(f[c].y+d[a].y)/2};}}return{start:d,end:g};};Graph.prototype.processControlPoint=function(e){var d=e.length;var c=[];var f=[];f[0]=2;for(var b=1;b<d;b++){var a=1/f[b-1];f[b]=(b<(d-1)?4:3.5)-a;e[b]-=a*e[b-1];}c[d-1]=e[d-1]/f[d-1];for(var b=(d-2);b>=0;b--){c[b]=(e[b]-c[b+1])/f[b];
}return c;};Graph.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height);this.canvas.width=this.width;};Graph.prototype.redraw=function(){this.clear();this.draw();};Graph.prototype.getGridAxes=function(){var g=this.options.padding+(this.options.border>0?this.options.border:0);var c=this.options.spacing;
var q=g;var p=this.height-g;var j=this.height-(g*2);var k=this.width-(g*2);var a=this.lines[0]["data"].length;var b=k;var f={x:[],y:[]};if(this.lines.length>1){for(var o=0;o<this.lines.length;o++){if(this.lines[o]["data"].length>a){a=this.lines[o]["data"].length;}}}b=b/(a-1);for(var d=0;d<a;d++){var t=q+(d*b);
f.x.push({y:p,x:t});}var n=this.options.gridYCount;var b=j/(n+1);var h=this.getMinimum();var r=this.getMaximum();var s=r-h;var e=(s/(n+1));var m=j-(c*2);var l=(e/m)*c;for(var d=0;d<n;d++){var t=q+((d+1)*b);f.y.push({y:t,x:q,recommended:h+((n-d)*(e))+l-(l*(d*n))});}return f;};Graph.prototype.getClosestBullet=function(j,g){var h=[];
var g=g===false?false:true;if(this.options.useOffset){var j=j-this.getOffset().x;}if(g){this.redraw();}for(var l=0;l<this.lines.length;l++){var e=this.lines[l]["bullets"];var m=this.lines[l]["meta"];var d=e.length;var c=false;var b=this.width/(d-1);for(var f=0;f<d;f++){var a=e[f];var i=f==0?0:a.x-b;var k=Math.floor((a.x-i)/2)-(this.options.padding/2);
if(j<i||j>a.x){continue;}if(j<=(i+k)){c=f==0?a:e[f-1];c.meta=f==0?m[f]:m[f-1];break;}else{c=a;c.meta=m[f];break;}}h.push(c);this.context.strokeStyle=this.parseColor(this.lines[l]["lineColor"]=="default"?this.options.lineColor:this.lines[l]["lineColor"]);this.context.fillStyle=this.options.bulletFill?this.parseColor(this.options.bulletColor):this.context.strokeStyle;
if(g){this.context.beginPath();this.context.arc(c.x,c.y,(this.options.bulletSize*1.4),0,Math.PI*2,false);this.context.closePath();this.context.fill();if(this.options.bulletFill){this.context.stroke();}}}if(h.length==0){return[];}else{if(h.length==1){return h[0];}}return h;};Graph.prototype.getOffset=function(){var a=this.canvas;
var b=this.options.padding+(this.options.border>0?this.options.border:0);var c={x:b,y:b};while(a&&a.offsetParent){c.x+=a.offsetLeft;c.y+=a.offsetTop;a=a.offsetParent;}return c;};Graph.prototype.parseColor=function(a){if(typeof(a)=="object"||typeof(a)=="array"){var e=this.context.createLinearGradient(0,0,0,this.height);
var d=1/(a.length-1);for(var c=0;c<a.length;c++){var b=c*d;if(b>1){b=1;}e.addColorStop(b,a[c]);}return e;}return a;};Graph.prototype.toString=function(){return"[object Graph.js]";};